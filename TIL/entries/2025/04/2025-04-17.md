# ğŸ“˜ TIL: 2025-04-16

## ğŸŒ Overview

I'm currently building a global portfolio to transition into international freelance development.  
With a background in both internal IT and cloud architecture, I manage small-scale projects end-to-end â€” from infrastructure to automation â€” with documentation fully in English.

Today focused on building scalable automation with **Google Apps Script** and **Slack integration**, alongside ongoing **GCP certification study**.

---
äº†è§£ã§ã™ï¼ä»¥ä¸‹ã« **è‹±èªãƒ¡ã‚¤ãƒ³ï¼‹æ—¥è‹±ä½µè¨˜** ã® TILã‚¹ã‚¿ã‚¤ãƒ«ã§ã¾ã¨ã‚ã¾ã—ãŸ âœ…  
Upwork ã‚„ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªå…±æœ‰ã«ã‚‚ãã®ã¾ã¾ä½¿ãˆã‚‹æ§‹æˆã§ã™ã€‚

---

## âœ… Highlights (æˆæœ)
# ğŸ“˜ TIL: 2025-04-16 â€“ Shift_JIS CSV Encoding Fix on Cloud Run

---

## âœ… What I Did / ä»Šæ—¥ã‚„ã£ãŸã“ã¨  
Fixed an issue in the CSV conversion process where some characters were dropped during UTF-8 to Shift_JIS encoding.  
å¯¾å¿œã—ã¦ã„ãªã„è¨˜å·ã‚„è£…é£¾æ–‡å­—ã«ã‚ˆã£ã¦ã€Shift_JISå¤‰æ›æ™‚ã«ä¸€éƒ¨ã®æ–‡å­—ãŒæ¬ è½ã™ã‚‹å•é¡Œã‚’ä¿®æ­£ã—ã¾ã—ãŸã€‚  
The process runs on **Cloud Run using Python**, and was updated to replace problematic characters with ASCII-safe alternatives.

---

## ğŸ’¡ Key Takeaways / æ°—ã¥ã  
- Shift_JIS cannot represent certain characters, which may cause data loss or encoding errors  
  â†’ Shift_JISã§ã¯ä¸€éƒ¨ã®æ–‡å­—ï¼ˆç‰¹æ®Šè¨˜å·ãªã©ï¼‰ã«éå¯¾å¿œã§ã€å¤‰æ›ã«å¤±æ•—ã¾ãŸã¯æ¬ è½ãŒç™ºç”Ÿã™ã‚‹  
- It's safer to proactively convert unsupported characters to ASCII before encoding  
  â†’ äº‹å‰ã« `ascii()` ã¾ãŸã¯å¤‰æ›ãƒãƒƒãƒ”ãƒ³ã‚°ã§ä»£æ›¿è¡¨ç¾ã«ç½®æ›ã™ã‚‹ã®ãŒæœ‰åŠ¹  
- Pythonâ€™s standard libraries (`encode`, `replace`, `errors='ignore'`) are sufficient for lightweight handling  
  â†’ Cloud Runç’°å¢ƒã§ã‚‚ã€è»½é‡ãªæ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã ã‘ã§å®‰å…¨ã«å‡¦ç†å¯èƒ½

---

## ğŸ”§ Notes / æŠ€è¡“ãƒ¡ãƒ¢  
- The conversion logic was added to `processor.py`  
  `processor.py` ã«å¤‰æ›å‡¦ç†ã‚’å®Ÿè£…ï¼ˆ`str.encode('shift_jis', errors='replace')` ãªã©ï¼‰  
- Replaced unsupported symbols to avoid broken output in Excel and legacy tools  
  Excelã‚„ãƒ¬ã‚¬ã‚·ãƒ¼ãƒ„ãƒ¼ãƒ«ã§ã®è¡¨ç¤ºå´©ã‚Œé˜²æ­¢ã®ãŸã‚ã€ç‰¹æ®Šæ–‡å­—ã‚’å®‰å…¨ãªæ–‡å­—ã«ç½®æ›  
- Final files were saved in Shift_JIS while keeping structure and quotes untouched  
  ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ ã‚„ã‚¯ã‚©ãƒ¼ãƒˆï¼ˆ"`"ï¼‰ã¯ä¿æŒã—ãŸã¾ã¾ã€Shift_JISã§ä¿å­˜

---

## ğŸ·ï¸ Tags  
- [x] Cloud Run  
- [x] Python  
- [x] CSV  
- [x] Encoding  
- [x] GCS  



## âœ… å…ˆæœˆã®æœ€å¤§æˆæœ / Highlight of the Week

ğŸš€ **Cloud Run + FTPS ã‚’é€£æºã—ãŸã€Œã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ãƒ»ãƒ•ã‚¡ã‚¤ãƒ«è»¢é€ APIã€æ§‹ç¯‰ã«æˆåŠŸï¼**  
Built a fully automated FTPS transfer API using Cloud Run, supporting static IP and GCS triggers.

---

## ğŸ”§ æ§‹æˆã¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« / Architecture & Modules

```
serverless-ftps-api-public/
â”œâ”€â”€ A_cloudrun-api/      # Cloud Run API + GCS trigger
â”œâ”€â”€ B_ftps-server/       # FTPS server on GCE
â””â”€â”€ C_vpc-networking/    # VPC Connector + NAT for static IP
```

- GCS ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ Cloud Run ãŒèµ·å‹•ã—ã€FTPS ã«è»¢é€ã•ã‚Œã‚‹  
- Static IP ã‚’ Cloud NAT + VPC Connector ã§å®Ÿç¾  
- FTPS ã¯ Passive ãƒ¢ãƒ¼ãƒ‰ã§ã€Firewall ã‚„ãƒãƒ¼ãƒˆãƒ¬ãƒ³ã‚¸ã‚‚èª¿æ•´æ¸ˆã¿

---

## ğŸ—ï¸ ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆå›³ / System Diagram

```
[GCS] â”€â”€> [Cloud Run API] â”€â”€> [FTPS Server (GCE)]
               â”‚
      (Static IP via VPC Connector + NAT)
```

---

## ğŸ§ª å®Ÿè¡Œãƒ­ã‚° / Execution Log

```bash
$ bash 03_test_cloud_run.sh

âœ… ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº† / File uploaded  
âœ… Cloud Run ç™ºç«ç¢ºèª / Triggered  
âœ… FTPS ã‚µãƒ¼ãƒãƒ¼ã«è»¢é€æˆåŠŸ / File transfer succeeded

Transfer completed:
upload_test_20250323050140.txt -> /home/your_username/upload_test_20250323050140.txt
```

---

## ğŸ§  å­¦ã³ãƒ»æ°—ã¥ã / Learnings & Takeaways

- Cloud Run ã§å¤–éƒ¨ FTPS ã«æ¥ç¶šã™ã‚‹ã«ã¯å›ºå®šIPæ§‹æˆãŒå¿…é ˆ  
  â†’ Static IP configuration is required for Cloud Run to access external FTPS  
- VPC Connector + Cloud NAT ã‚’çµ„ã¿åˆã‚ã›ã¦æ§‹æˆ  
  â†’ Combining VPC Connector and Cloud NAT works well  
- FTPS ã¯ Passive ãƒ¢ãƒ¼ãƒ‰åˆ©ç”¨æ™‚ã« Firewall ã¨ NAT ã®è¨­è¨ˆãŒéµ  
  â†’ Passive mode FTPS requires careful port and firewall design  
- Terraform ã‚’ä½¿ã‚ãªãã¦ã‚‚ã€ã‚·ã‚§ãƒ«ã¨ JSON ã§å†ç¾ã§ããŸ  
  â†’ Infra setup was reproducible with shell + JSON, no Terraform needed

---

## ğŸ“Œ ãã®ä»–é€²æ— / Other Progress

- CloudShell ã‹ã‚‰ zip åŒ–ã—ã¦ Codespaces ã«è»¢é€ãƒ»å±•é–‹å®Œäº†  
  â†’ Zipped files and moved to Codespaces successfully  
- `.gitignore` ã‚’ä½¿ã£ã¦æ®µéšçš„ã«ã‚³ãƒ¼ãƒ‰å…¬é–‹æº–å‚™ä¸­  
  â†’ Using .gitignore to control staged releases  
- GCP ã‚³ã‚¹ãƒˆæœ€å°åŒ–ã®ãŸã‚æ¤œè¨¼ç’°å¢ƒã®ã¿æ§‹ç¯‰  
  â†’ Setup done on a test-only basis to minimize GCP billing

---

## ğŸ”œ æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ / Next Steps

- README ã‚’ GitHub ã§å…ˆè¡Œå…¬é–‹äºˆå®š  
  â†’ Start with README release on GitHub  
- SFTP ã‚„ä»–ã‚µãƒ¼ãƒ“ã‚¹é€£æºã«ã‚‚å¿œç”¨å¯èƒ½ã‹æ¤œè¨  
  â†’ Explore SFTP or other system integration  
- Zennã«è¨˜äº‹åŒ–
  â†’ Turn it into a blog post
- ã€Œã‚¯ãƒ©ã‚¦ãƒ‰å®Œçµ Ã— é‹ç”¨ä¸è¦ Ã— å›ºå®šIPã€æ§‹æˆã®äº‹ä¾‹åŒ–  
  â†’ Make this a showcase of â€œserverless + no ops + fixed IPâ€ architecture


---
