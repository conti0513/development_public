name: AI Worker
on:
  repository_dispatch:
    types: [ai-exec-command]

jobs:
  execute:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create TIL File and PR
        run: |
          # PayloadãŒç©ºã ã£ãŸå ´åˆã®ã‚¬ãƒ¼ãƒ‰ãƒ¬ãƒ¼ãƒ«ã‚’è¨­ç½®
          RAW_CATEGORY="${{ github.event.client_payload.category }}"
          CATEGORY="${RAW_CATEGORY:-01_TIL}"
          
          RAW_FILENAME="${{ github.event.client_payload.filename }}"
          FILENAME="${RAW_FILENAME:-$(date +'%Y%m%d_%H%M%S')_til.md}"
          
          RAW_CONTENT="${{ github.event.client_payload.content }}"
          CONTENT="${RAW_CONTENT:-'Claude 3.5 Sonnet ã‹ã‚‰ã®å¿œç­”ã€ã¾ãŸã¯PayloadãŒç©ºã§ã—ãŸã€‚ï½—ï½—ï½—'}"

          mkdir -p "$CATEGORY"
          echo "$CONTENT" > "$CATEGORY/$FILENAME"
          
          git config user.name "AI Junior"
          git config user.email "ai-junior@example.com"
          
          BRANCH_NAME="ai-til-$(date +'%s')"
          git checkout -b $BRANCH_NAME
          git add .
          git commit -m "ğŸ¤– AI Entry: $FILENAME"
          git push origin $BRANCH_NAME
          
          gh pr create --title "ğŸ¤– AI Entry: $FILENAME" --body "SlackæŠ•ç¨¿ã‹ã‚‰CTOæµTILãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§è‡ªå‹•ç”Ÿæˆã—ã¾ã—ãŸã€‚" --base main --head $BRANCH_NAME
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
