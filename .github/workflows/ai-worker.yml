name: AI Worker
on:
  repository_dispatch:
    types: [ai-exec-command]

jobs:
  execute:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create TIL File and PR
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ENCODED_CONTENT: ${{ github.event.client_payload.content }}
        run: |
          CATEGORY="${{ github.event.client_payload.category || '05_AGENT_OUTPUTS/04_JOURNAL' }}"
          FILENAME="${{ github.event.client_payload.filename || 'til.md' }}"
          mkdir -p "$CATEGORY"

          # ðŸš€ å®‰å…¨ã«ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦å°å°è§£é™¤
          echo "$ENCODED_CONTENT" | base64 --decode > "$CATEGORY/$FILENAME"

          git config user.name "AI Junior"
          git config user.email "ai-junior@example.com"
          BRANCH_NAME="ai-til-$(date +'%s')"
          git checkout -b "$BRANCH_NAME"
          git add .
          if ! git diff --cached --exit-code --quiet; then
            git commit -m "ðŸ¤– AI Entry: $FILENAME"
            git push origin "$BRANCH_NAME"
            gh pr create --title "ðŸ¤– AI Entry: $FILENAME" --body "Base64 Mode Activated. ID: ${{ github.event.client_payload.reqID }}" --base main --head "$BRANCH_NAME"
          fi
