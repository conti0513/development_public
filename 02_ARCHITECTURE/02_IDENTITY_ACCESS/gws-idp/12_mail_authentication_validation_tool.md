## 📄 05_mail_authentication_validation_tool.md

## 🧪 メール認証（SPF/DKIM/DMARC/BIMI）診断ツール：最終設計仕様

〜「届かない不安」を「技術的な確信」に変えるドメイン品質管理システム〜

### 1. 開発の背景と目的

ドメイン移行およびその後の運用において、DNS設定ミスによるメール不達はビジネス上の致命的な損失を招く。本ツールは、人間が手動（dig等）では追いきれない「DNSの再帰的な依存関係」を自動検証し、常時RFC準拠の状態を維持するためのガードレールとして機能する。

### 2. システム・アーキテクチャ（設計ロジック）

Go言語によるサーバーレス・アーキテクチャを採用し、受信サーバー側（審判）の挙動をシミュレートする。

#### ① 再帰的解析エンジン (Recursive SPF Resolver)

* **ロジック**: `net.LookupTXT` を使用し、`include` 先のドメインを再帰的に掘り下げる。
* **評価基準**: RFC 7208 準拠。DNS Lookup 回数が 10 回を超えた時点で `Critical` 判定。
* **検証項目**: `a`, `mx`, `include`, `ptr`, `exists` 等の全メカニズムを網羅。

#### ② DMARC/BIMI 整合性エンジン

* **DMARCチェック**: `p=quarantine` または `p=reject` の有無、および `rua/ruf` の有効性を検証。
* **BIMI資産検証**: `default._bimi` レコードから SVG ロゴの URL を抽出し、HTTPS 接続性と到達性を確認。

### 3. UI/UX 仕様（人間中心の診断体験）

エンジニア以外のステークホルダー（CTO・プロジェクトマネージャー）も一目で状況を把握できるインターフェースを提供する。

#### ① インターフェース

* **Simple Scan**: ドメイン名を入力するだけの 1 画面構成。
* **Visual Status**:
* 🔴 **Critical**: 即座に配送不達が発生するリスク（RFC違反）。
* 🟡 **Warning**: 設定の境界値、または推奨されないポリシー。
* 🟢 **Pass**: 全項目がベストプラクティスに準拠。



#### ② 解析結果の可視化

* **SPF Dependency Tree**: ネストされた `include` 構造をインデント表示し、どこで Lookup 回数を消費しているかを可視化。
* **処方箋メッセージ**: エラー内容に対し、「サブドメインへの分離」「不要なレコードの削除」といった具体的なアクションプランを提示。

### 4. 運用・実装上のポイント（CTOへの訴求）

* **継続的な変更管理**: メルマガスタンドの変更やSaaS導入のたびに「枠の空き（Lookup余裕数）」を即座に確認可能。
* **ゼロ・メンテナンス**: Cloud Run を採用。リクエスト時のみ起動するため、運用コスト（課金）はほぼゼロ。
* **CI/CD 統合可能**: Terraform 実行後の自動テストとして組み込み、記述ミスによる事故を構造的に防ぐ。

### 5. 導入によるベネフィット

* **品質の標準化**: 担当者のスキルに依存せず、常に RFC 準拠の「合格証」をベースにリリースができる。
* **意思決定の高速化**: 複雑な技術仕様を「信号機」に変えることで、移行のゴーサインを迅速に出せる。

---

### 💡 実装に向けた「伴走メモ」

1. **Back-end**: Go で `type DomainResult struct` を定義し、再帰ロジックを書く（15分）。
2. **Front-end**: Tailwind CSS で診断画面のテンプレートを作成（15分）。
3. **Integration**: ロジックと画面を繋ぎ、Cloud Run へデプロイ（20分）。
