### **GCS â†’ Cloud Functions â†’ SFTP è»¢é€ï¼ˆå£æ‰“ã¡ãƒ¡ãƒ¢ï¼‰**  

#### **âœ… è¦ä»¶**
- **GCS ã« CSV ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€è‡ªå‹•ã§ SFTP ã«è»¢é€**
- **ã‚¤ãƒ™ãƒ³ãƒˆãƒ‰ãƒªãƒ–ãƒ³ï¼ˆCloud Functionsï¼‰**
- **æœ€å°æ§‹æˆã§ãƒ†ã‚¹ãƒˆ**
- **SFTP ã‚µãƒ¼ãƒãƒ¼ã¯æ—¢ã«èµ·å‹•æ¸ˆã¿**
- **GCP ã® `--set-env-vars` ã‚’ä½¿ç”¨ã—ã¦ç’°å¢ƒå¤‰æ•°ã‚’ç®¡ç†**
- **æœ¬ç•ªã¯ Secret Manager ã«ç§»è¡Œã™ã‚‹å¯èƒ½æ€§ã‚ã‚Š**

---





#### **âœ… ä½œæ¥­ã‚¹ãƒ†ãƒƒãƒ—**
1. **GCS ã« CSV ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰**  
   - ãƒã‚±ãƒƒãƒˆä½œæˆï¼ˆ`my-test-bucket`ï¼‰  
   - ãƒ†ã‚¹ãƒˆç”¨ CSV ã‚’ã‚¢ãƒƒãƒ—  

2. **Cloud Functions ã‚’ä½œæˆ**  
   - **ãƒˆãƒªã‚¬ãƒ¼:** GCS ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰  
   - **ãƒ©ãƒ³ã‚¿ã‚¤ãƒ :** Python 3.9  
   - **ç’°å¢ƒå¤‰æ•°ï¼ˆ`--set-env-vars`ï¼‰ã§ SFTP æ¥ç¶šæƒ…å ±ã‚’ç®¡ç†**  

3. **SFTP è»¢é€ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè£…**  
   - `paramiko` ã‚’ä½¿ç”¨  
   - ç’°å¢ƒå¤‰æ•°ã‹ã‚‰ SFTP æƒ…å ±ã‚’å–å¾—  
   - GCS ã‹ã‚‰ CSV ã‚’å–å¾—ã—ã€SFTP ã«è»¢é€  

4. **Cloud Functions ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤**  
   - `requirements.txt` ã« `paramiko` ã‚’è¿½åŠ   
   - `--set-env-vars` ã§ SFTP æ¥ç¶šæƒ…å ±ã‚’è¨­å®š  
   - ãƒ‡ãƒ—ãƒ­ã‚¤ã‚³ãƒãƒ³ãƒ‰ï¼š
     ```bash
     gcloud functions deploy gcs_to_sftp \
       --runtime python39 \
       --trigger-resource my-test-bucket \
       --trigger-event google.storage.object.finalize \
       --set-env-vars SFTP_HOST="192.168.1.100",SFTP_PORT="22",SFTP_USER="sftpuser",SFTP_PASSWORD="P@ssw0rd!"
     ```

5. **ãƒ†ã‚¹ãƒˆ & ãƒ­ã‚°ç¢ºèª**  
   - GCS ã« CSV ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰  
   - Cloud Functions ã®ãƒ­ã‚°ã‚’ç¢ºèª  
   - SFTP ã«ãƒ•ã‚¡ã‚¤ãƒ«ãŒè»¢é€ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯  

---

#### **âœ… æ³¨æ„ç‚¹**
- **`--set-env-vars` ã¯ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«ã—ã‹è¨­å®šã§ããªã„**ï¼ˆå¤‰æ›´æ™‚ã¯å†ãƒ‡ãƒ—ãƒ­ã‚¤ï¼‰  
- **æœ¬ç•ªç’°å¢ƒã§ã¯ Secret Manager ã‚’æ¨å¥¨**  
- **Cloud Functions ã¯çŸ­æ™‚é–“å®Ÿè¡Œã®ãŸã‚ã€é•·æ™‚é–“å‡¦ç†ã¯é©ã•ãªã„**  
- **SFTP ã®èªè¨¼æ–¹å¼ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ or éµèªè¨¼ï¼‰ã¯ä»Šå¾Œæ¤œè¨**  

---

### **âœ… ã¾ã¨ã‚**
- **ã¾ãš `--set-env-vars` ã§ãƒ†ã‚¹ãƒˆ â†’ å‹•ä½œç¢ºèªå¾Œã« Secret Manager ã¸ç§»è¡Œ**
- **SFTP è»¢é€ãŒæˆåŠŸã™ã‚Œã° OK**
- **ä¸å…·åˆãŒã‚ã‚Œã° Cloud Functions ã®ãƒ­ã‚°ã‚’ãƒã‚§ãƒƒã‚¯**
- **GCS â†’ Cloud Functions â†’ SFTP è»¢é€ã®æµã‚Œã‚’æœ€å°æ§‹æˆã§å®Ÿè£…**

---
### **GCS â†’ Cloud Functions â†’ SFTP è»¢é€ï¼ˆã‚³ãƒ¼ãƒ‰é›†ï¼‰**  
### **âœ… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ & éµèªè¨¼ã®ä¸¡æ–¹ã«å¯¾å¿œã™ã‚‹æ±ç”¨ã‚³ãƒ¼ãƒ‰**
ğŸ”¹ **ç’°å¢ƒå¤‰æ•°ã§ã€Œãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ or éµèªè¨¼ã€ã‚’åˆ‡ã‚Šæ›¿ãˆå¯èƒ½**  
ğŸ”¹ **ã©ã¡ã‚‰ã®èªè¨¼æ–¹å¼ã‹ä¸æ˜ã§ã‚‚ã€ãã®ã¾ã¾å‹•ä½œã™ã‚‹**  
ğŸ”¹ **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒ `None` ã®å ´åˆã€éµèªè¨¼ã‚’ä½¿ç”¨ã™ã‚‹**  

---

### **1ï¸âƒ£ `main.py`ï¼ˆæ±ç”¨ç‰ˆ SFTP è»¢é€ï¼‰**
```python
import os
import paramiko
from google.cloud import storage, secretmanager

# ç’°å¢ƒå¤‰æ•°ã‹ã‚‰ SFTP æ¥ç¶šæƒ…å ±ã‚’å–å¾—
SFTP_HOST = os.getenv("SFTP_HOST")
SFTP_PORT = int(os.getenv("SFTP_PORT", 22))
SFTP_USER = os.getenv("SFTP_USER")
SFTP_PASSWORD = os.getenv("SFTP_PASSWORD")  # Noneãªã‚‰éµèªè¨¼
SFTP_PRIVATE_KEY_PATH = os.getenv("SFTP_PRIVATE_KEY_PATH")  # Noneãªã‚‰ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼
SFTP_REMOTE_PATH = os.getenv("SFTP_REMOTE_PATH", "/upload/")

# Secret Manager ã‹ã‚‰ç§˜å¯†éµã‚’å–å¾—ï¼ˆå¿…è¦ãªå ´åˆï¼‰
def get_secret(secret_id):
    client = secretmanager.SecretManagerServiceClient()
    name = f"projects/<PROJECT_ID>/secrets/{secret_id}/versions/latest"
    return client.access_secret_version(name=name).payload.data.decode("UTF-8")

if SFTP_PRIVATE_KEY_PATH and SFTP_PRIVATE_KEY_PATH.startswith("projects/"):
    SFTP_PRIVATE_KEY = get_secret(SFTP_PRIVATE_KEY_PATH)
else:
    SFTP_PRIVATE_KEY = None

def upload_to_sftp(file_name, file_content):
    """SFTP ã« CSV ã‚’è»¢é€ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ or éµèªè¨¼ï¼‰"""
    transport = paramiko.Transport((SFTP_HOST, SFTP_PORT))

    if SFTP_PASSWORD:  # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼
        transport.connect(username=SFTP_USER, password=SFTP_PASSWORD)
    elif SFTP_PRIVATE_KEY:  # Secret Manager ã‹ã‚‰å–å¾—ã—ãŸéµ
        pkey = paramiko.RSAKey.from_private_key(SFTP_PRIVATE_KEY)
        transport.connect(username=SFTP_USER, pkey=pkey)
    elif SFTP_PRIVATE_KEY_PATH:  # ãƒ­ãƒ¼ã‚«ãƒ«ã®éµãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨
        pkey = paramiko.RSAKey.from_private_key_file(SFTP_PRIVATE_KEY_PATH)
        transport.connect(username=SFTP_USER, pkey=pkey)
    else:
        raise ValueError("SFTP ã®èªè¨¼æƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã¾ã™")

    sftp = paramiko.SFTPClient.from_transport(transport)

    remote_file = f"{SFTP_REMOTE_PATH}/{file_name}"
    with sftp.file(remote_file, 'w') as f:
        f.write(file_content)

    sftp.close()
    transport.close()

def gcs_to_sftp(event, context):
    """GCS ã®æ–°è¦ CSV ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ SFTP ã«è»¢é€"""
    bucket_name = event['bucket']
    file_name = event['name']

    if not file_name.endswith(".csv"):
        print(f"Skipping non-CSV file: {file_name}")
        return

    storage_client = storage.Client()
    bucket = storage_client.bucket(bucket_name)
    blob = bucket.blob(file_name)

    file_content = blob.download_as_text()
    upload_to_sftp(file_name, file_content)
    print(f"Uploaded {file_name} to SFTP successfully")
```

---

### **2ï¸âƒ£ `requirements.txt`ï¼ˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼‰**
```txt
google-cloud-storage
google-cloud-secret-manager
paramiko
```

---

### **3ï¸âƒ£ Cloud Functions ã®ãƒ‡ãƒ—ãƒ­ã‚¤**
```bash
gcloud functions deploy gcs_to_sftp \
  --runtime python39 \
  --trigger-resource my-bucket \
  --trigger-event google.storage.object.finalize \
  --set-env-vars SFTP_HOST="192.168.1.100",SFTP_PORT="22",SFTP_USER="sftpuser",SFTP_PASSWORD="",SFTP_PRIVATE_KEY_PATH="projects/<PROJECT_ID>/secrets/SFTP_PRIVATE_KEY",SFTP_REMOTE_PATH="/upload/"
```

ğŸ”¹ **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ã®å ´åˆ:** `SFTP_PASSWORD="P@ssw0rd!"` ã‚’è¨­å®š  
ğŸ”¹ **éµèªè¨¼ã®å ´åˆ:** `SFTP_PRIVATE_KEY_PATH="projects/<PROJECT_ID>/secrets/SFTP_PRIVATE_KEY"` ã«è¨­å®š  

---

### **âœ… ã¾ã¨ã‚**
âœ” **ç’°å¢ƒå¤‰æ•°ã ã‘ã§ã€Œãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ or éµèªè¨¼ã€ã‚’åˆ‡ã‚Šæ›¿ãˆå¯èƒ½**  
âœ” **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒè¨­å®šã•ã‚Œã¦ã„ã‚Œã°ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ã€ãªã‘ã‚Œã°éµèªè¨¼ã‚’ä½¿ç”¨**  
âœ” **Secret Manager ã§éµ (`id_rsa`) ã‚’å®‰å…¨ã«ç®¡ç†å¯èƒ½**  
âœ” **ã©ã¡ã‚‰ã®èªè¨¼æ–¹å¼ã‹ã‚ã‹ã‚‰ãªãã¦ã‚‚ã€ã“ã®ã‚³ãƒ¼ãƒ‰ã§å¯¾å¿œOKï¼**

ğŸ’¡ **ã“ã‚Œã§ã€æœ¬ç•ªã§ã‚‚ãƒ†ã‚¹ãƒˆã§ã‚‚æŸ”è»Ÿã«å¯¾å¿œã§ãã‚‹ï¼** ğŸš€