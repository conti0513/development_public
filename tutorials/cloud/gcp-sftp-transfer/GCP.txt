GCPåŒºé–“ã®é–‹ç™º

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®š
PROJECT_ID="gcp-sftp-transfer"
gcloud config set project $PROJECT_ID

ç¢ºã‹ã«ã€Eventarc ã‚„ Cloud Functions ã® SA ã«ã¯ã‚‚ã£ã¨å¤šãã®æ¨©é™ã‚’ä»˜ä¸ã—ã¾ã—ãŸã€‚  
å¿…è¦ãªæ¨©é™ã‚’ **ç¶²ç¾…çš„ã«æ•´ç†** ã—ãŸã†ãˆã§ã€**ãƒ¯ãƒ³ãƒ©ã‚¤ãƒŠãƒ¼ã§ç®¡ç†ã—ã‚„ã™ã„å½¢** ã«ä¿®æ­£ã—ã¾ã™ã€‚  

---

### âœ… **GCP: Cloud Functions & Eventarc è¨­å®šæ‰‹é †ï¼ˆæœ€çµ‚ç‰ˆï¼‰**
ğŸ“Œ **è·å ´ã®ã‚¸ãƒ¥ãƒ‹ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢å‘ã‘ã®æ‰‹é †æ›¸**

---

## **ğŸ“Œ 1ï¸âƒ£ GCP ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¨­å®š**
```sh
PROJECT_ID="gcp-sftp-transfer"
gcloud config set project $PROJECT_ID
```
ğŸ“Œ **ä½œæ¥­ã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ GCP ã«è¨­å®š**

---

## **ğŸ“Œ 2ï¸âƒ£ å¿…è¦ãª API ã‚’æœ‰åŠ¹åŒ–**
```sh
gcloud services enable cloudfunctions.googleapis.com \
    eventarc.googleapis.com \
    storage.googleapis.com \
    pubsub.googleapis.com \
    cloudbuild.googleapis.com \
    run.googleapis.com \
    iam.googleapis.com
```
ğŸ“Œ **Cloud Functions, Eventarc, Cloud Storage, Pub/Sub ãªã©å¿…è¦ãª API ã‚’æœ‰åŠ¹åŒ–**

---

## **ğŸ“Œ 3ï¸âƒ£ GCS ãƒã‚±ãƒƒãƒˆã‚’ä½œæˆ**
```sh
gcloud storage buckets create gs://gcp-gcs-bucket --location=asia-northeast1
```
ğŸ“Œ **Cloud Storage ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹ãŸã‚ã®ãƒã‚±ãƒƒãƒˆã‚’ä½œæˆï¼ˆæ±äº¬ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ï¼‰**

---

## **ğŸ“Œ 4ï¸âƒ£ Cloud Functions ã®ã‚³ãƒ¼ãƒ‰ã‚’æº–å‚™**
### **ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ**
```sh
mkdir -p ~/gcp-cf-sftp-transfer && cd ~/gcp-cf-sftp-transfer
```
ğŸ“Œ **`gcp-cf-sftp-transfer` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã€ãã“ã«ç§»å‹•**

### **`main.py` ã‚’ä½œæˆ**
```sh
cat <<EOF > main.py
import os
import paramiko
from google.cloud import storage

# ç’°å¢ƒå¤‰æ•°ã‹ã‚‰ SFTP æ¥ç¶šæƒ…å ±ã‚’å–å¾—
SFTP_HOST = os.getenv("SFTP_HOST")
SFTP_PORT = int(os.getenv("SFTP_PORT", 22))
SFTP_USER = os.getenv("SFTP_USER")
SFTP_PASSWORD = os.getenv("SFTP_PASSWORD")
SFTP_REMOTE_PATH = os.getenv("SFTP_REMOTE_PATH", "/upload/")

def upload_to_sftp(file_name, file_content):
    """SFTP ã« CSV ã‚’è»¢é€"""
    transport = paramiko.Transport((SFTP_HOST, SFTP_PORT))
    transport.connect(username=SFTP_USER, password=SFTP_PASSWORD)
    sftp = paramiko.SFTPClient.from_transport(transport)

    remote_file = f"{SFTP_REMOTE_PATH}/{file_name}"
    with sftp.open(remote_file, 'wb') as f:
        f.write(file_content.encode())

    sftp.close()
    transport.close()
    print(f"âœ… {file_name} ã‚’ SFTP ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†")

def gcs_to_sftp(event, context):
    """GCS ã®æ–°è¦ CSV ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ SFTP ã«è»¢é€"""
    bucket_name = event.get('bucket')
    file_name = event.get('name')

    if not file_name.endswith(".csv"):
        print(f"âš ï¸ ã‚¹ã‚­ãƒƒãƒ—: {file_name} ã¯ CSV ã§ã¯ã‚ã‚Šã¾ã›ã‚“")
        return

    storage_client = storage.Client()
    bucket = storage_client.bucket(bucket_name)
    blob = bucket.blob(file_name)

    file_content = blob.download_as_text()
    upload_to_sftp(file_name, file_content)
EOF
```
ğŸ“Œ **GCS ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸ CSV ã‚’ SFTP ã«è»¢é€ã™ã‚‹ Cloud Function ã‚’ä½œæˆ**

### **`requirements.txt` ã‚’ä½œæˆ**
```sh
cat <<EOF > requirements.txt
paramiko
google-cloud-storage
EOF
```
ğŸ“Œ **å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æŒ‡å®š**

---

## **ğŸ“Œ 5ï¸âƒ£ Cloud Functions ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤**
```sh
gcloud functions deploy gcp-cf-sftp-transfer \
    --gen2 \
    --runtime python310 \
    --region asia-northeast1 \
    --source . \
    --entry-point gcs_to_sftp \
    --trigger-event-filters="type=google.cloud.storage.object.v1.finalized" \
    --trigger-event-filters="bucket=gcp-gcs-bucket" \
    --allow-unauthenticated \
    --set-env-vars SFTP_HOST="your_sftp_host",SFTP_PORT="22",SFTP_USER="your_user",SFTP_PASSWORD="your_password",SFTP_REMOTE_PATH="/upload/"
```
ğŸ“Œ **Cloud Functions ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã€ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š**

---

## **ğŸ“Œ 6ï¸âƒ£ Cloud Functions ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å–å¾—**
```sh
CF_SA=$(gcloud functions describe gcp-cf-sftp-transfer --region=asia-northeast1 --format="value(serviceConfig.serviceAccountEmail)")
echo "Cloud Functions SA: $CF_SA"
```
ğŸ“Œ **å¾Œã§æ¨©é™ã‚’ä»˜ä¸ã™ã‚‹ãŸã‚ã«ãƒ¡ãƒ¢**

---

## **ğŸ“Œ 7ï¸âƒ£ Eventarc ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å–å¾—**
```sh
EVENTARC_SA=$(gcloud projects get-iam-policy $PROJECT_ID \
    --flatten="bindings[].members" \
    --format="value(bindings.members)" \
    --filter="bindings.role:roles/eventarc.serviceAgent")
echo "Eventarc SA: $EVENTARC_SA"
```
ğŸ“Œ **Eventarc ãŒ GCS ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ã‘å–ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã«å–å¾—**

---

## **ğŸ“Œ 8ï¸âƒ£ IAM æ¨©é™ã‚’ä»˜ä¸**
```sh
CLOUD_BUILD_SA="705919400451@cloudbuild.gserviceaccount.com"
GCS_SA="service-705919400451@gs-project-accounts.iam.gserviceaccount.com"

for SA in "$CF_SA" "$EVENTARC_SA"; do
    gcloud projects add-iam-policy-binding $PROJECT_ID --member="serviceAccount:$SA" --role="roles/eventarc.admin"
    gcloud projects add-iam-policy-binding $PROJECT_ID --member="serviceAccount:$SA" --role="roles/eventarc.serviceAgent"
    gcloud projects add-iam-policy-binding $PROJECT_ID --member="serviceAccount:$SA" --role="roles/iam.serviceAccountTokenCreator"
    gcloud projects add-iam-policy-binding $PROJECT_ID --member="serviceAccount:$SA" --role="roles/pubsub.publisher"
    gcloud projects add-iam-policy-binding $PROJECT_ID --member="serviceAccount:$SA" --role="roles/storage.objectViewer"
    gcloud projects add-iam-policy-binding $PROJECT_ID --member="serviceAccount:$SA" --role="roles/eventarc.eventReceiver"
    gcloud projects add-iam-policy-binding $PROJECT_ID --member="serviceAccount:$SA" --role="roles/run.invoker"
done

# Cloud Build SA ã« Storage Admin ã‚’ä»˜ä¸
gcloud projects add-iam-policy-binding $PROJECT_ID --member="serviceAccount:$CLOUD_BUILD_SA" --role="roles/storage.admin"

# GCS SA ã« Pub/Sub Publisher ã‚’ä»˜ä¸
gcloud projects add-iam-policy-binding $PROJECT_ID --member="serviceAccount:$GCS_SA" --role="roles/pubsub.publisher"
```
ğŸ“Œ **å¿…è¦ãª IAM æ¨©é™ã‚’ä»˜ä¸**

---

## **ğŸ“Œ 9ï¸âƒ£ Eventarc ãƒˆãƒªã‚¬ãƒ¼ä½œæˆ**
```sh
gcloud eventarc triggers create gcs-trigger \
    --location=asia-northeast1 \
    --destination-run-service=gcp-cf-sftp-transfer \
    --destination-run-region=asia-northeast1 \
    --event-filters="type=google.cloud.storage.object.v1.finalized" \
    --event-filters="bucket=gcp-gcs-bucket" \
    --service-account=$CF_SA
```
ğŸ“Œ **Eventarc ãŒ GCS ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ Cloud Functions ã«é€šçŸ¥ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹**

---

## **ğŸ“Œ ğŸ”¥ 10ï¸âƒ£ å‹•ä½œãƒ†ã‚¹ãƒˆ**
```sh
echo "test,data" > test.csv
gcloud storage cp test.csv gs://gcp-gcs-bucket
```
ğŸ“Œ **GCS ã« `test.csv` ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ â†’ Cloud Functions ãŒç™ºç«ã—ã¦ SFTP ã¸è»¢é€**

### **ãƒ­ã‚°ã‚’ç¢ºèª**
```sh
gcloud functions logs read gcp-cf-sftp-transfer --region=asia-northeast1 --limit=10
```
ğŸ“Œ **ã‚¨ãƒ©ãƒ¼ãŒãªã„ã‹ç¢ºèª**

---

ğŸš€ **ã“ã®æ‰‹é †ã‚’é †ç•ªã«å®Ÿè¡Œã™ã‚Œã°ã€GCP ã® Cloud Functions & Eventarc ã®è¨­å®šãŒå®Œäº†ï¼**