### **GCP VPCä¸Šã«SFTPã‚µãƒ¼ãƒãƒ¼ã‚’æ§‹ç¯‰ã™ã‚‹æ‰‹é †ï¼ˆæ±ç”¨ç‰ˆï¼‰**  
â€»ã“ã®æ‰‹é †ã§ã¯ã€GCPä¸Šã«VPCã‚’ä½œæˆã—ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆçµŒç”±ã§SFTPã‚’å—ä¿¡ã§ãã‚‹ç’°å¢ƒã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚  

---

## **1. VPCã¨ã‚µãƒ–ãƒãƒƒãƒˆã®ä½œæˆ**
```bash
gcloud compute networks create my-vpc --subnet-mode=custom
```
```bash
gcloud compute networks subnets create my-subnet \
    --network=my-vpc \
    --range=10.10.0.0/24 \
    --region=<ãƒªãƒ¼ã‚¸ãƒ§ãƒ³>
```

---
äº†è§£ã—ã¾ã—ãŸï¼GCS â†’ Cloud Functions â†’ åŸºå¹¹FTPã‚µãƒ¼ãƒãƒ¼ï¼ˆSFTPï¼‰ã®ãƒ‡ãƒ¼ã‚¿è»¢é€ã‚’ **æœ€çŸ­** ã§æ§‹ç¯‰ã™ã‚‹ãŸã‚ã®æ‰‹é †ã‚’ææ¡ˆã—ã¾ã™ã€‚

---

## **æœ€çŸ­ã®æ§‹ç¯‰æ‰‹é †**
### **1. GCEï¼ˆSFTPã‚µãƒ¼ãƒãƒ¼ï¼‰ã‚’ä½œæˆ**
```sh
gcloud compute instances create core-ftp-server \
    --zone=asia-northeast1-a \
    --machine-type=e2-medium \
    --image-family=debian-11 \
    --image-project=debian-cloud \
    --scopes=storage-ro,cloud-platform \
    --metadata=enable-oslogin=TRUE \
    --tags=sftp-server \
    --boot-disk-size=20GB
```
> - `--metadata=enable-oslogin=TRUE` ã‚’è¨­å®šã—ã€Google ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã® SSH èªè¨¼ã‚’ä½¿ç”¨ã™ã‚‹  
> - å¿…è¦ã«å¿œã˜ã¦ `--tags=sftp-server` ã‚’ä½¿ã„FWãƒ«ãƒ¼ãƒ«ã‚’è¨­å®š  

---

### **2. SFTPç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ**
```sh
sudo useradd -m -s /bin/bash sftpuser && \
sudo mkdir -p /home/sftpuser/.ssh && \
sudo chmod 700 /home/sftpuser/.ssh
```

---

### **3. ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰å…¬é–‹éµã‚’è¨­å®š**
ãƒ­ãƒ¼ã‚«ãƒ«ï¼ˆMac/PCï¼‰ã§ **å…¬é–‹éµã‚’ã‚µãƒ¼ãƒãƒ¼ã«ã‚³ãƒ”ãƒ¼**
```sh
ssh-keygen -t rsa -b 4096 -f ~/.ssh/sftp_key
ssh-copy-id -i ~/.ssh/sftp_key.pub sftpuser@YOUR_SFTP_SERVER_IP
```

---

### **4. SSHã®è¨­å®š**
```sh
echo "PubkeyAuthentication yes
PasswordAuthentication no
Subsystem sftp internal-sftp
Match User sftpuser
    ChrootDirectory /home/sftpuser
    ForceCommand internal-sftp
    AllowTcpForwarding no
    X11Forwarding no" | sudo tee -a /etc/ssh/sshd_config
```
> - **å…¬é–‹éµèªè¨¼ã‚’æœ‰åŠ¹åŒ–**  
> - **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ã¯ç„¡åŠ¹åŒ–**  
> - **SFTPå°‚ç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®Chrootè¨­å®š**

---

### **5. SSHã‚µãƒ¼ãƒ“ã‚¹ã‚’å†èµ·å‹•**
```sh
sudo systemctl restart sshd
```

---

### **6. Firewallãƒ«ãƒ¼ãƒ«ã®è¨­å®š**
```sh
gcloud compute firewall-rules create allow-sftp \
    --allow=tcp:22 \
    --target-tags=sftp-server
```

---

### **7. SFTPæ¥ç¶šãƒ†ã‚¹ãƒˆ**
ãƒ­ãƒ¼ã‚«ãƒ«PCã‹ã‚‰
```sh
sftp -i ~/.ssh/sftp_key sftpuser@YOUR_SFTP_SERVER_IP
```

---

### **8. GCSã‹ã‚‰SFTPã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è»¢é€ï¼ˆCloud Functionsï¼‰**
Cloud Functions ã§ SFTP ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è»¢é€ã™ã‚‹ **Python ã‚¹ã‚¯ãƒªãƒ—ãƒˆ**
```python
import paramiko
from google.cloud import storage

SFTP_HOST = "YOUR_SFTP_SERVER_IP"
SFTP_PORT = 22
SFTP_USER = "sftpuser"
SFTP_KEY_PATH = "/path/to/sftp_key"  # Cloud Functionsã®Secret Managerã«ä¿å­˜æ¨å¥¨

GCS_BUCKET_NAME = "gcp-gcs-bucket"
GCS_FILE_NAME = "test.txt"
SFTP_DEST_PATH = "/home/sftpuser/uploaded_test.txt"

def transfer_file(event, context):
    storage_client = storage.Client()
    bucket = storage_client.bucket(GCS_BUCKET_NAME)
    blob = bucket.blob(GCS_FILE_NAME)
    
    local_temp_file = f"/tmp/{GCS_FILE_NAME}"
    blob.download_to_filename(local_temp_file)
    
    # SFTPè»¢é€
    key = paramiko.RSAKey(filename=SFTP_KEY_PATH)
    transport = paramiko.Transport((SFTP_HOST, SFTP_PORT))
    transport.connect(username=SFTP_USER, pkey=key)
    sftp = transport.open_sftp()
    sftp.put(local_temp_file, SFTP_DEST_PATH)
    sftp.close()
    transport.close()
```

> - `paramiko` ã‚’ä½¿ç”¨ã—ã¦ **GCSã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’SFTPã«è»¢é€**  
> - `gcloud functions deploy transfer_file --runtime python39 --trigger-event google.storage.object.finalize --trigger-resource gcp-gcs-bucket`

---

## **ã¾ã¨ã‚**
1. **GCEï¼ˆSFTPã‚µãƒ¼ãƒãƒ¼ï¼‰ã‚’ä½œæˆ**
2. **SFTPãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ**
3. **å…¬é–‹éµèªè¨¼ã‚’è¨­å®š**
4. **SSH/SFTPã‚’æœ‰åŠ¹åŒ–**
5. **Cloud Functionsã§GCS â†’ SFTPã«ãƒ•ã‚¡ã‚¤ãƒ«è»¢é€**

---

### **ã“ã‚Œã§æœ€çŸ­ã§SFTPæ§‹ç¯‰ â†’ GCSé€£æºãŒå¯èƒ½ã§ã™ï¼**
ğŸ’¡ **ã‚ã¨1æ™‚é–“ã§å®Œæˆã•ã›ã‚‹ãï¼ğŸ’ª**