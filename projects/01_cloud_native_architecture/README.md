# クラウド構成に関する個人メモ（GCP / IaC）

## 概要

本リポジトリは、  
これまでに触れた一般的なクラウド構成や運用例について、  
個人用メモとして整理した内容です。

特定の案件や組織を前提としたものではなく、  
自己学習・理解整理のための記録です。

---

## 例01：外部環境（SFTP / FTPS）との接続構成

サーバーレス環境（Cloud Run）から、  
外部の SFTP / FTPS 環境へ接続するケースについて整理した例です。

送信元IPの固定や、認証情報の取り扱いに制約がある状況を前提としています。

### 背景として想定される制約

- サーバーレス環境から外部サーバーへ接続する必要がある
- 接続元IPの固定が求められる
- 秘密鍵や認証情報をアプリケーションに直接持たせたくない
- 障害時に再実行・切り戻しを容易にしたい

### 構成の整理

- **Cloud Run + VPC Connector + Cloud NAT**
  - Cloud Run の通信を VPC 経由とし、Cloud NAT により送信元IPを固定
- **SFTP クライアント（Go）**
  - 軽量な処理のみを担当し、状態を保持しない構成
- **認証情報の扱い**
  - 秘密鍵をコードやコンテナイメージに含めない前提で整理

### 運用面で考慮していた点

- **IaC（Terraform）対応**
  - 検証環境ではリソースを Terraform で管理
  - 必要に応じてコード管理へ移行できる状態を維持
- **設定値の分離**
  - 接続先パスやユーザーIDなどの可変情報は JSON で外出し
  - 環境変更時は設定修正と再デプロイのみで対応可能な形を想定

```mermaid
graph LR
    subgraph GCP
        CR[Cloud Run] --> VC[VPC Connector]
        VC --> NAT[Cloud NAT（固定IP）]
    end
    NAT --> EXT[外部 SFTP / FTPS サーバー]
````

---

## 例02：イベント起点のデータ連携構成（変換・配送）

Cloud Storage を起点に、
データ加工と外部配送を行う構成について整理した例です。

### 処理の流れ

1. **データ出力**
   BigQuery から定期的にデータを出力
2. **イベント検知**
   GCS へのファイル格納を Eventarc で検知し、Cloud Run を起動
3. **加工処理**
   Go / Python にて文字コード変換（SJIS 対応等）を実施
4. **配送**
   完成したファイルを外部 SFTP サーバーへ転送

### 構成上の整理ポイント

* **冪等性**

  * 処理途中で失敗しても、ファイルを再配置することで再実行可能な形
* **ステートレス**

  * 処理状態をアプリ内に保持せず、再デプロイのみで復旧可能
* **ログの整理**

  * OS層・アプリ層で共通フォーマットのログ出力を行い、調査しやすい形を維持
* **エラー時の対応**

  * Cloud Logging を起点に、エラー内容と再実行手順を記録する運用を想定

```mermaid
graph TD
    BQ[(BigQuery)] -->|定期実行| GCS[Cloud Storage]
    GCS -->|Eventarc| CR[Cloud Run]
    CR -->|文字コード変換| SFTP[外部 SFTP]
    CR -.->|エラー| LOG[Cloud Logging]
    LOG -.->|記録| NOTE[対応メモ]
```

---

## 共通して意識していた点（整理）

* **CLIベースで再現できること**

  * 可能な限りコマンドラインから再現できる手順を前提
* **認証情報を増やさない**

  * 鍵や資格情報を極力持たせない構成を想定
* **復旧しやすい構成**

  * 再デプロイや再実行で元の状態に戻せることを重視

---

## 補足

* 本内容は、個人の理解整理を目的としたメモです
* 特定の業務・案件・組織の構成を示すものではありません
* 設計提案やベストプラクティスを示す意図はありません
