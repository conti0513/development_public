### 04_id_integration_hands_on_verification.md

# 🧪 GWS・IdP統合：実機検証・デバッグ手順

## 〜「不整合」をあえて作り、挙動の解像度を爆上げする〜

本ドキュメントは、設計上の「想定」が実機でどのようにログやデータとして現れるかを検証し、商談・設計における技術的根拠（エビデンス）を確立するための手順である。

---

## 1. SSO（SAML）の不整合・限界突破検証

単なるログイン成功ではなく、ドメイン移行期に発生する「不整合」を意図的に再現し、デバッグ能力を養う。

### 1-1. SAMLアサーションの「生データ」解読

* **検証目的:** IdP（HENNGE等）が発行するXMLのどの属性が、GWSのどのフィールドに紐付いているかを物理的に理解する。
* **手順:**
1. Cloud Run等で `/saml/acs`（受け口）を仮設し、受信した `SAMLResponse` をBase64デコードしてログ出力する。
2. ログから以下の3点を探し出し、メモする。
* `<saml:Issuer>`：IdPの識別子が想定通りか。
* `<saml:NameID>`：ここが「旧ドメイン」のままでないか。
* `<saml:Attribute Name=".../email">`：属性としてメールアドレスがどう渡されているか。




* **商談へのフィードバック:** 「NameIDが新ドメインに切り替わっていない場合、GWS側でログインエラー（403等）が出ることを実機ログで確認済みです」

### 1-2. 「ドメイン不一致」による認証拒否の再現

* **検証目的:** GWS側のプライマリドメイン変更に対し、IdPの設定変更が遅れた際の挙動を確認する。
* **手順:**
1. GWS側のテストユーザーを `user@new-hd.com`（新）に変更。
2. 擬似IdP（Cloud Run）から、あえて `NameID: user@old-subsidiary.com`（旧）を送信。
3. 発生するエラー（Google側のログイン不可画面）と、その際のブラウザデベロッパーツールの「Network」タブに残る `SAMLResponse` を突合する。



---

## 2. メール配送・コンプライアンスルールの境界検証

ドメイン追加に伴う「配送拒否」や「なりすまし判定」をコードとログで制御する。

### 2-1. SPF/DMARC の「わざと失敗」試験（Terraform連動）

* **検証目的:** DNS反映待ち時間や、設定ミスが相手先に与える影響を可視化する。
* **手順:**
1. Terraform（Cloud DNS）で、SPFレコードから `_spf.google.com` を一時的に削除し `apply`。
2. その状態でGmail等へテスト送信。
3. **確認項目:** 受信メールの「メッセージのソース」を表示し、以下を確認。
* `spf=softfail` または `fail`
* `dmarc=fail`




* **商談へのフィードバック:** 「新ドメイン追加時、DNSのTTLが原因で最大○分間は配送が不安定になるリスクを実機で計測済みです」

### 2-2. コンプライアンスルールの「すり抜け」検証

* **検証目的:** 旧ドメインからの送信を「拒否」するルールが、エイリアスや転送時にどう動くかを確認する。
* **手順:**
1. GWS管理コンソールで「旧ドメインをFromに含む送信を拒否」するルールを作成。
2. **意地悪テスト:**
* 「新ドメイン」をメインとし、「旧ドメイン」をエイリアス（別名）に持つユーザーから送信。
* 外部から「旧ドメイン」宛に届いたメールを「新ドメイン」へ自動転送した際の挙動。


3. Cloud Logging（Gmailログ検索）で、どのルールが適用（Match）されたか証跡を追う。



---

## 3. 自動化・ライフサイクル（Kill Switch）の検証

HENNGE等のIdP側で操作した際、どの程度のラグでGWSへ波及するかを体感する。

### 3-1. 即時遮断（Revoke Session）のタイムラグ計測

* **検証目的:** IDを「Suspend（中断）」した際、すでにログイン済みのセッションがいつ切れるかを確認する。
* **手順:**
1. テストユーザーでGWS（Gmail/Drive）にログインしておく。
2. 管理者画面（またはIdP側）でユーザーを「無効」にする。
3. ブラウザをリロードし、ログイン画面にリダイレクトされるまでの時間を計測。


* **商談へのフィードバック:** 「IDの無効化からセッションの完全破棄までには若干のラグがあるため、緊急時は『全セッションの消去』を併用する運用フローを推奨します」

---

## 4. 検証済みコード・スニペット（Terraform）

実機検証で「一瞬で環境を作って、一瞬で壊す」ために使用するコード断片。

```hcl
# 検証用：新ドメインのSPF/DMARCを即座に作成
resource "google_dns_record_set" "new_domain_spf" {
  name         = "new-hd.com."
  type         = "TXT"
  ttl          = 300
  managed_zone = var.target_zone
  rrdatas      = ["v=spf1 include:_spf.google.com ~all"]
}

# 検証用：DMARC（最初は p=none でログを見る）
resource "google_dns_record_set" "new_domain_dmarc" {
  name         = "_dmarc.new-hd.com."
  type         = "TXT"
  ttl          = 300
  managed_zone = var.target_zone
  rrdatas      = ["v=DMARC1; p=none; rua=mailto:admin@new-hd.com"]
}

```

---

## 5. 実機検証チェックリスト（商談前最終確認）

* [ ] SAMLのXMLから `NameID` を抽出できるか？
* [ ] SPF設定ミス時のメールヘッダ（Authentication-Results）を読めるか？
* [ ] GWS管理コンソールの設定反映ラグを、身をもって知っているか？
* [ ] Terraformで検証用のサブドメインを5分以内に立ち上げられるか？

---