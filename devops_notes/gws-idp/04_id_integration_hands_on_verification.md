## `04_id_integration_hands_on_verification.md`

# 🧪 GWS・IdP統合

## 実機ハンズオン検証・デバッグ手順

### 〜「不整合」をあえて作り、挙動の解像度を上げる〜

本ドキュメントは、
Google Workspace（GWS）における **SSO 認証** および
**メール認証（DNS / SPF / DMARC）** の挙動について、

**実機・実ログを使って検証し、
設計・判断に使える事実ベースの理解を得ること**を目的とする。

設計書上の想定ではなく、

> *実際に何が送られ、
> どこで拒否され、
> 管理者側から何が観測できるのか*

を、自分の手で確認するためのハンズオン手順である。

---

## 1. SSO 認証の不整合検証（ドメイン移行期）

単に「ログインできた／できない」ではなく、
**ドメイン移行時に起きやすいズレを意図的に再現**し、

* 管理者は何を見られるのか
* ユーザー視点ではどう見えるのか

を切り分けて確認する。

---

### 1-1. 認証データの中身を直接確認する

#### 検証目的

SSO 認証時に、IdP（HENNGE 等）から
**どのユーザー情報が、どの形で送られているか**を把握する。

※ 内部的には XML 形式（SAML）だが、
　本検証では **仕様理解ではなく「実際の値の確認」** を目的とする。

#### 手順

1. Cloud Run 等で、認証データの受信口（例：`/sso/receive`）を簡易的に用意する
2. 受信したデータをデコードし、ログとして出力する
3. ログから以下を確認する

   * **発行元情報**
     → 想定している IdP から送られているか
   * **ユーザー識別情報**
     → メールアドレス／ドメインがどう渡っているか
   * **付随情報**
     → 属性として新旧どちらのアドレスが使われているか

#### 確認ポイント

* ユーザー識別情報が **旧ドメインのまま送信されていないか**
* 新ドメインと旧ドメインが混在していないか

#### 設計・判断時の言い換え

> 「SSO 認証時に、旧ドメインのユーザー情報が
> 実際に送信されているケースを、管理者ログで確認しています」

---

### 1-2. ドメイン不一致による認証エラーの再現

#### 検証目的

GWS 側のドメイン切り替えと、
IdP 側の設定変更がズレた場合に、

**どのようなエラーが発生し、
管理者側で何が確認できるか**を把握する。

#### 手順

1. GWS 側のテストユーザーを **新ドメイン** に変更
2. 認証データとして、あえて **旧ドメインのユーザー情報** を送信
3. 以下を確認

   * ログイン不可画面の表示
   * ブラウザの Network タブに残る認証データ
   * 管理者ログ側での記録内容

#### ポイント

* ユーザー視点：
  「ログインできない」だけで原因は分からない
* 管理者視点：
  **どの情報が原因で拒否されたかを追跡できる状態を作る**

---

## 2. メール配送・DNS 設定の境界検証

ドメイン追加・移行時に発生しやすい
**メール不達・なりすまし判定** を、
あえて発生させて挙動を確認する。

---

### 2-1. SPF / DMARC の意図的な失敗検証

#### 検証目的

DNS 設定ミスや反映遅延が、
**受信側からどう見えるか**を実ログで確認する。

#### 手順

1. Terraform で SPF レコードを一時的に崩す
   （例：Google の送信元定義を除外）
2. その状態で Gmail 等へテスト送信
3. 受信メールの「メッセージのソース」を確認

#### 確認項目

* `spf=fail` / `softfail`
* `dmarc=fail`
* メールの扱い（迷惑メール・警告表示など）

#### 設計・判断時の言い換え

> 「DNS 設定や TTL の影響で、
> 一時的に配送が不安定になる時間帯が発生することを
> 実機で確認しています」

---

### 2-2. コンプライアンスルールのすり抜け確認

#### 検証目的

「旧ドメインからの送信を止める」ルールが、
**エイリアスや転送時にどう振る舞うか**を確認する。

#### 手順

1. 旧ドメインを含む送信を拒否するルールを作成

2. 以下のケースをテスト

   * 新ドメインをメイン、旧ドメインを別名に持つユーザーから送信
   * 旧ドメイン宛メールを新ドメインへ自動転送

3. 管理ログで、どのルールが適用されたかを確認

---

## 3. ID 無効化・即時遮断の挙動確認

### 3-1. アカウント停止時のラグを体感する

#### 検証目的

ユーザーを無効化した際、
**すでにログイン済みのセッションがいつ切れるか**を確認する。

#### 手順

1. テストユーザーで GWS にログイン
2. 管理画面または IdP 側でユーザーを無効化
3. 再読み込み・操作時の挙動を観察

#### ポイント

* 即時切断されるケース
* 数分残るケース
* 全セッション破棄が必要なケース

#### 設計・判断時の言い換え

> 「緊急時は、ユーザー停止に加えて
> 全セッション無効化を併用する運用が現実的です」

---

## 4. 検証用 Terraform スニペット（DNS）

```hcl
# 検証用：SPF
resource "google_dns_record_set" "spf_test" {
  name         = "new-hd.com."
  type         = "TXT"
  ttl          = 300
  managed_zone = var.target_zone
  rrdatas      = ["v=spf1 include:_spf.google.com ~all"]
}

# 検証用：DMARC（まずはログ取得）
resource "google_dns_record_set" "dmarc_test" {
  name         = "_dmarc.new-hd.com."
  type         = "TXT"
  ttl          = 300
  managed_zone = var.target_zone
  rrdatas      = ["v=DMARC1; p=none; rua=mailto:admin@new-hd.com"]
}
```

---

## 5. 実機検証チェックリスト

* [ ] 認証データ内のユーザー情報をログで確認できる
* [ ] SPF / DMARC 失敗時のメールヘッダを読める
* [ ] 設定反映のラグを実体験している
* [ ] Terraform で検証環境を即作成・即破棄できる

---

## 6. まとめ

本手順により、

* SSO 認証
* ドメイン移行
* メール配送
* 設定反映ラグ

を **机上ではなく、実挙動として把握**できる。

これは、

> 「どこが悪いかを探す」

のではなく、

> **「どこが原因ではないかを先に潰す」**

ための検証である。

---

## 補足：認証データ観測用「診断センサー」の運用パターン

### パターン1：個別診断モード（トラブル調査用）

* 特定ユーザーに「調査用リンク」からログインを依頼
* 裏側で認証データを記録し、原因を即時特定
* 必要に応じて、画面上に
  「OK」「旧ドメインの可能性あり」など簡易表示も可能

### パターン2：全量モニタリングモード（移行当日）

* IdP の送信先を一時的にセンサーへ向ける
* 全ユーザーの認証試行を記録しつつ、本来の GWS へ中継
* 移行漏れ・旧設定端末を網羅的に洗い出せる

※ 本番組み込み時は、Cloud Run の冗長化・制限解除など
　**信頼性設計が前提条件**となる。

---