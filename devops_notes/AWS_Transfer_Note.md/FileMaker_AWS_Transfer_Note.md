# AWS環境移行テストノート（技術オブザーバー用・検証済み）

---

## 1. 推奨 Markdown ファイル名

👉 **`FileMaker_AWS_Transfer_Note_Verified.md`**

---

## 2. 環境構成図（検証済みモデル）

```text
【 移行元：先方AWSテナント 】          【 移行先：自社AWSテナント 】
+----------------------------+       +----------------------------+
| VPC (Old)                  |       | VPC (New)                  |
|  +----------------------+  |       |  +----------------------+  |
|  | [fm-server]          |  |       |  | [fm-server]          |  |
|  | Windows 2022         |  | ====> |  | Windows 2022         |  |
|  | IP: 10.1.x.x         |  | 移行  |  | IP: 10.1.1.225       |  |
+----------------------------+       +----------------------------+
                                             ^
                                             | VPC Peering (pcx-xxxx)
                                             v
                                     +----------------------------+
                                     | [fm-client]                |
                                     | Windows 2022               |
                                     | IP: 10.3.1.224             |
                                     +----------------------------+
                                      ※ 自社VPCからのプライベート接続

```

---

## 3. プロジェクト概要

* **目的**: 別テナント（ベンダー管理）から自社AWSテナントへの FileMaker 環境完全移行の検証。
* **ミッション**: 技術的オブザーバーとして、**「AMI不使用・クリーンインストールなし」という条件下での疎通不全リスク**を事前に潰す。

---

## 4. 検証によって確定した「正解」のパラメータ

本日実施した実機検証に基づき、以下の設定が「通信成立の必須条件」であることを特定済み。

* **ネットワーク**: VPC Peering経由の双方向ルーティング設定。
* **セキュリティグループ (SG)**:
* `TCP 5003` (FM DB通信)
* `TCP 3389` (RDP)
* `ICMP` (疎通診断用Ping) ※プロトコル制限なしの開放を推奨。


* **Windows OS (検証済み知見)**:
* **Network Profile**: `Private` への強制変更が必要（デフォルトの `Public` ではFWが牙を剥く）。
* **Firewall Rules**: 5003番およびICMPのエコー要求を明示的にAllow設定。



---

## 5. 技術的懸念点（地雷リストと実証結果）

### 5.1 移行方式の矛盾（AMIなし/クリーンなし）

* **リスク**: AMIを使わず「データと設定だけ運ぶ」場合、OS側のレジストリやインターフェースの「識別ID」が変わり、ネットワークプロファイルが `Public` にリセットされる。
* **実証結果**: 検証中、実際にプロファイル不整合によるTimedOutが発生。OS側での `Set-NetConnectionProfile` 実行が移行当日の必須手順であることを確認。

### 5.2 EIP 変更リスクと名前解決

* **リスク**: IP直打ち設計の場合、クライアント数百台の設定変更が発生する。
* **対策**: 移行を機に、VPC Peering経由のプライベートDNSまたは `hosts` 配布による抽象化を推奨。

---

## 6. 本日実施した検証結果（L3-L4完全疎通）

### 6.1 検証ステップ

1. TerraformによるVPC/Peering/EC2の自動構築。
2. サーバー側で「即席5003ポート・リスナー」を起動（FileMaker実機なしで検証）。
3. クライアント側から `Test-NetConnection` を実行。

### 6.2 疎通証明データ（エビデンス）

```powershell
# クライアント(10.3.1.224) から サーバー(10.1.1.225) への結果
ComputerName     : 10.1.1.225
TcpTestSucceeded : True   # <--- これが勝利の証
PingSucceeded    : True

```

---

## 7. オブザーバーとして突きつける「5つの武器」

1. **「土管の確証」**:
「VPC PeeringとSGの設定は正しいか？」を問う前に、自前で用意した5003番リスナースクリプトを提示し、インフラの正当性をその場で証明できる。
2. **「プロファイル地雷の指摘」**:
「AMIを使わないなら、起動直後にOSがPublicネットワークだと判断して通信を弾くはずだが、その対策コマンドは手順書にあるか？」と追求できる。
3. **「パスワードリセット権限の警告」**:
「SSM経由での鍵開けにはKMSの復号権限が必要だが、IAMロールの設計は漏れていないか？」と事前に釘を刺せる。
4. **「ICMPドロップの指摘」**:
「Pingが通らないのはSGだけの問題か、OSデフォルトのステルスモードのせいか？」の切り分けをリードできる。
5. **「再現性の担保」**:
「この構成はTerraformでコード化済みであり、何度でも同じ『正解』を再現できる」という基準値を持っていることによる交渉優位性。

---

## 8. コストと効率のまとめ

* **検証時間**: 約1.5時間
* **コスト**: 数百円（Windows 2台分）
* **成果**: 「アプリを入れる前にインフラが100%正しい」ことを証明する手法の確立。

---
